<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Komo Bot</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Menggunakan font Inter sebagai default */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Kustomisasi scrollbar agar lebih tipis */
        #chat-window::-webkit-scrollbar {
            width: 6px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background: #d1d5db; /* gray-300 */
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-gray-100 min-h-screen flex items-center justify-center p-0 sm:p-4">

    <div class="flex flex-col h-screen sm:h-[95vh] w-full max-w-3xl mx-auto bg-white shadow-2xl rounded-none sm:rounded-lg overflow-hidden">
        
        <!-- Header Aplikasi -->
        <header class="bg-blue-600 text-white p-4 shadow-md z-10">
            <h1 class="text-2xl font-bold text-center">Komo Bot</h1>
        </header>

        <!-- Jendela Chat -->
        <main id="chat-window" class="flex flex-col flex-grow p-4 sm:p-6 space-y-5 overflow-y-auto bg-gray-50">
            <!-- Pesan akan ditambahkan di sini oleh JavaScript -->
        </main>

        <!-- Area Input Pesan -->
        <footer class="p-4 bg-white border-t border-gray-200">
            <form id="chat-form" class="flex items-center space-x-3">
                <input
                    type="text"
                    id="message-input"
                    placeholder="Ketik pesan Anda..."
                    autocomplete="off"
                    class="flex-grow border border-gray-300 rounded-full py-3 px-5 h-12 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                />
                <button
                    type="submit"
                    id="send-button"
                    class="bg-blue-600 text-white rounded-full p-3 h-12 w-12 flex items-center justify-center hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                    <!-- Ikon Send (Kirim) SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
                        <path d="M3.105 3.105a.5.5 0 01.815-.093l14.09 11.026a.5.5 0 01-.01 1.05l-3.98 1.096a.5.5 0 01-.434-.434l-1.096-3.979a.5.5 0 011.05-.01l11.026 14.09a.5.5 0 01-.093.815l-4.211 1.631a.5.5 0 01-.613-.303l-3.41-8.293a.5.5 0 01-.023-.105l-8.293-3.41a.5.5 0 01-.303-.613l1.631-4.21z" />
                    </svg>
                </button>
            </form>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Seleksi Elemen DOM ---
            const chatWindow = document.getElementById('chat-window');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');

            // --- State Aplikasi ---
            // Menyimpan riwayat percakapan untuk dikirim ke API
            // Format diubah untuk kompatibilitas OpenAI/Groq: [{role: '...', content: '...'}]
            let chatHistory = [];
            
            // Instruksi sistem untuk AI (disimpan sebagai pesan pertama)
            const systemMessage = { 
                role: 'system',
                content: "Anda adalah Komo Bot, asisten AI yang ramah, membantu, dan selalu merespon dalam Bahasa Indonesia. Buat jawaban Anda rapi, jelas, dan profesional. Gunakan paragraf yang terstruktur dengan baik. **PENTING: Jangan pernah** gunakan format Markdown. Karakter seperti `*` (bintang) atau `#` (pagar) dilarang keras." 
            };
            // Langsung tambahkan ke riwayat
            chatHistory.push(systemMessage);


            // --- API Configuration ---
            // ===================================================================
            // PERHATIAN KEAMANAN (SECURITY WARNING)
            // ===================================================================
            // Kunci API Anda dimasukkan di sini. 
            // JANGAN PERNAH membagikan file HTML ini secara publik 
            // atau meng-hostingnya di web, karena siapa pun dapat 
            // melihat kunci API Anda dan menggunakannya. 
            // Ini hanya untuk pengujian lokal di komputer Anda.
            // ===================================================================
            const groqApiKey = "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"; 
            
            const groqModelName = 'openai/gpt-oss-20b'; // Model Groq yang akan digunakan (ANDA MINTA DIGANTI)
            const apiUrl = 'https://api.groq.com/openai/v1/chat/completions';

            // --- Fungsi ---

            /**
             * Menambahkan pesan baru ke UI chat.
             * @param {string} text - Teks pesan.
             * @param {'user' | 'model' | 'error'} role - Pengirim pesan.
             * @param {boolean} [isLoading=false] - Apakah ini pesan loading.
             */
            function addMessageToUI(text, role, isLoading = false) {
                const messageElement = document.createElement('div');
                // --- PERUBAHAN TAMPILAN BUBBLE ---
                messageElement.classList.add(
                    // 'flex', // Dihapus - tidak perlu di bubble
                    // 'flex-col', // Dihapus
                    'max-w-sm',       // Max-width sedikit lebih besar
                    'sm:max-w-lg', 
                    'rounded-xl',     // Lebih bulat
                    'p-3',            // Padding
                    'sm:p-4', 
                    'shadow-md',      // Shadow lebih jelas
                    'text-sm',        // Ukuran font
                    'sm:text-base', 
                    'leading-6'       // Jarak antar baris (untuk kerapian)
                );
                
                let textNode;
                // Menangani newlines dalam teks model
                if (role === 'model' && !isLoading) {
                    // --- PERUBAHAN: Menghapus parsing Markdown & Membersihkan '#' ---
                    // 1. Hapus karakter '#' secara paksa
                    let cleanText = text.replace(/#/g, ''); 
                    // 2. Ganti \n (baris baru) dengan <br>
                    messageElement.innerHTML = cleanText.replace(/\n/g, '<br>');
                } else {
                    textNode = document.createTextNode(text);
                    messageElement.appendChild(textNode);
                }

                if (role === 'user') {
                    // Pesan pengguna (biru, rata kanan)
                    // --- PERUBAHAN STYLE ---
                    messageElement.classList.add(
                        'bg-blue-600',    // Warna brand
                        'text-white',     // Teks putih
                        'self-end', 
                        'rounded-br-none' // Ekor pesan
                    );
                } else if (role === 'model') {
                    // Pesan bot (putih, rata kiri)
                    // --- PERUBAHAN STYLE ---
                    messageElement.classList.add(
                        'bg-white',           // Latar belakang putih
                        'text-gray-800',      // Teks lebih gelap
                        'border',             // Border tipis
                        'border-gray-200', 
                        'self-start', 
                        'rounded-bl-none'     // Ekor pesan
                    );
                    if (isLoading) {
                        messageElement.id = 'loading-indicator';
                        messageElement.classList.add('animate-pulse'); // Efek loading
                    }
                } else if (role === 'error') {
                    // Pesan error (merah, rata kiri)
                    // --- PERUBAHAN STYLE ---
                    messageElement.classList.add(
                        'bg-red-500',     // Latar merah
                        'text-white',     // Teks putih
                        'self-start', 
                        'rounded-bl-none'
                    );
                }

                chatWindow.appendChild(messageElement);
                
                // Auto-scroll ke pesan terbaru
                chatWindow.scrollTop = chatWindow.scrollHeight;
                
                return messageElement; // Mengembalikan elemen untuk update (misal: loading)
            }

            /**
             * Mengirim riwayat chat ke Groq API dengan exponential backoff.
             * (Menggantikan callGeminiAPI)
             */
            async function callGroqAPI() {
                const payload = {
                    model: groqModelName,
                    messages: chatHistory, // Mengirim seluruh riwayat
                };
                
                try {
                    const response = await fetchWithBackoff(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${groqApiKey}` // Header otorisasi Groq
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        // Coba baca pesan error dari Groq jika ada
                        const errorBody = await response.json().catch(() => ({}));
                        const errorMsg = errorBody?.error?.message || `HTTP error! status: ${response.status}`;
                        throw new Error(errorMsg);
                    }

                    const result = await response.json();
                    
                    // Menghapus indikator loading
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }

                    if (result.choices && result.choices.length > 0) {
                        const botResponseText = result.choices[0].message.content;
                        
                        // Tambahkan ke UI dan riwayat
                        addMessageToUI(botResponseText, 'model'); // 'model' tidak apa-apa untuk UI
                        // Tambahkan ke riwayat dalam format Groq/OpenAI
                        // --- PERBAIKAN ---
                        // Mengganti 'model' dengan 'assistant' agar sesuai standar API Groq/OpenAI
                        chatHistory.push({ role: 'assistant', content: botResponseText }); 
                    } else {
                        // Jika tidak ada kandidat respon
                        throw new Error("Respon API tidak valid atau kosong.");
                    }

                } catch (error)
                {
                    console.error('Error memanggil Groq API:', error);
                    // Menghapus atau update loading indicator menjadi pesan error
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    addMessageToUI(`Maaf, terjadi kesalahan: ${error.message}. Silakan coba lagi.`, 'error');
                    
                    // Hapus pesan terakhir user dari riwayat agar bisa dicoba lagi
                    chatHistory.pop(); 
                } finally {
                    // Apapun hasilnya, aktifkan kembali form
                    enableForm();
                }
            }

            /**
             * Fungsi fetch dengan retry dan exponential backoff.
             */
            async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok && retries > 0 && (response.status === 429 || response.status >= 500)) {
                        // Jika rate limit (429) atau server error (5xx) dan masih ada percobaan
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    return response;
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw error; // Lempar error setelah percobaan terakhir gagal
                }
            }

            /**
             * Menangani pengiriman form.
             */
            function handleSubmit(event) {
                event.preventDefault();
                const messageText = messageInput.value.trim();

                if (!messageText) {
                    return; // Jangan kirim pesan kosong
                }

                // 1. Tampilkan pesan pengguna di UI
                addMessageToUI(messageText, 'user');

                // 2. Tambahkan ke riwayat chat (format Groq/OpenAI)
                chatHistory.push({ role: 'user', content: messageText });

                // 3. Tampilkan indikator loading
                addMessageToUI('...', 'model', true);

                // 4. Nonaktifkan form saat menunggu
                disableForm();

                // 5. Kosongkan input
                messageInput.value = '';

                // 6. Panggil API (panggil fungsi Groq baru)
                callGroqAPI();
            }

            function disableForm() {
                messageInput.disabled = true;
                sendButton.disabled = true;
                sendButton.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
            }

            function enableForm() {
                messageInput.disabled = false;
                sendButton.disabled = false;
                sendButton.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                messageInput.focus(); // Fokus kembali ke input
            }

            // --- Event Listeners ---
            chatForm.addEventListener('submit', handleSubmit);

            // --- Inisialisasi ---
            // Tambahkan pesan selamat datang saat aplikasi dimuat
            setTimeout(() => {
                addMessageToUI('Halo! Saya Komo Bot. Ada yang bisa saya bantu?', 'model');
            }, 500); // Sedikit jeda agar terlihat natural
        });
    </script>
</body>
</html>








