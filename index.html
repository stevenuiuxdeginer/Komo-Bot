<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Komo Bot - Asisten Labuan Bajo Anda</title>
    <!-- Memuat Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat font Inter --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... CSS yang ada ... */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Kustomisasi scrollbar */
        #chat-window::-webkit-scrollbar {
            width: 6px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        #chat-window::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animasi mengetik */
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #64748b;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(1) {
            animation-delay: -0.32s;
        }
        .typing-indicator span:nth-of-type(2) {
            animation-delay: -0.16s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* Styling untuk konten HTML di dalam bubble */
        .chat-bubble-content p {
            margin-bottom: 0.5rem; /* 8px */
        }
        .chat-bubble-content p:last-child {
            margin-bottom: 0;
        }
        .chat-bubble-content ul, .chat-bubble-content ol {
            margin-left: 1.25rem; /* 20px */
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            padding-left: 0.5rem; /* Tambahan padding untuk spasi */
        }
        .chat-bubble-content ul {
            list-style-type: disc;
        }
        .chat-bubble-content ol {
            list-style-type: decimal;
        }
        .chat-bubble-content li {
            margin-bottom: 0.25rem; /* 4px */
        }
        .chat-bubble-content strong {
            font-weight: 600;
        }

        /* Styling untuk gambar yang disisipkan */
        .chat-bubble-content img {
            width: 100%;
            height: auto;
            border-radius: 0.5rem; /* 8px */
            margin-top: 0.75rem; /* 12px */
            border: 1px solid #e2e8f0; /* border abu-abu muda */
            background-color: #f1f1f1; /* bg placeholder saat memuat */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex flex-col h-screen max-w-3xl mx-auto bg-white shadow-2xl rounded-lg overflow-hidden">
        
        <!-- Header --><header class="relative bg-gradient-to-r from-blue-600 to-cyan-500 text-white p-4 shadow-md">
            <h1 class="text-2xl font-bold text-center">ü¶é Komo Bot</h1>
            <p class="text-center text-sm text-blue-100">Asisten virtual Anda untuk semua hal tentang Labuan Bajo</p>
            
            <!-- Tombol suara dihapus dari sini -->

        </header>

        <!-- Jendela Chat --><main id="chat-window" class="flex-grow p-4 md:p-6 space-y-4 overflow-y-auto">
            <!-- Pesan akan ditambahkan di sini oleh JavaScript --></main>

        <!-- Indikator Mengetik --><div id="typing-indicator" class="px-6 pb-2 hidden">
            <div class="flex items-center space-x-2 bg-gray-200 text-gray-700 px-4 py-3 rounded-lg max-w-xs">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span class="text-sm font-medium">Komo Bot sedang mengetik...</span>
            </div>
        </div>

        <!-- Input Form --><footer class="bg-gray-50 border-t border-gray-200 p-4">
            <form id="input-form" class="flex items-center space-x-3">
                
                <!-- Tombol record dihapus dari sini -->

                <input type="text" id="chat-input" placeholder="Tanya tentang Labuan Bajo..." class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" autocomplete="off">
                <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-5 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span class="sr-only">Kirim</span>
                </button>
            </form>
        </footer>

    </div>

    <script type="module">
        // --- Konfigurasi API ---
        const API_KEY = ""; // Kunci API akan diinjeksi oleh lingkungan runtime
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

        // --- System Prompt untuk Komo Bot ---
        const SYSTEM_PROMPT = `Anda adalah "Komo Bot", asisten chatbot yang ramah, ceria, dan sangat berpengetahuan.
Spesialisasi utama Anda adalah Labuan Bajo, Nusa Tenggara Timur, Indonesia.
Tugas Anda adalah menjawab semua pertanyaan pengguna tentang Labuan Bajo dengan antusias dan informatif.

Cakupan pengetahuan Anda meliputi (namun tidak terbatas pada):
1.  **Tempat Wisata:** Pulau Komodo, Pulau Rinca, Pulau Padar, Pink Beach (Pantai Merah), Manta Point, Taka Makassar, Pulau Kanawa, Gili Laba, Air Terjun Cunca Wulang, Gua Rangko.
2.  **Aktivitas:** Melihat komodo, snorkeling, diving (lokasi dive site), trekking/hiking, sailing/liveaboard, menikmati sunset, berenang.
3.  **Akomodasi:** Rekomendasi hotel (budget, midrange, mewah), resor, hostel, dan pengalaman liveaboard (Phinisi).
4.  **Transportasi:** Cara menuju Labuan Bajo (pesawat, kapal), transportasi di dalam kota (ojek, sewa motor/mobil, taksi).
5.  **Kuliner:** Makanan khas lokal, rekomendasi restoran, pasar malam.
6.  **Budaya & Sejarah:** Suku Manggarai, tarian Caci, sejarah singkat Labuan Bajo sebagai desa nelayan.
7.  **Tips Perjalanan:** Waktu terbaik berkunjung (musim), apa yang harus dibawa, tips keamanan, estimasi budget, paket tur.

Aturan Interaksi:
-   **BAHASA:** Deteksi bahasa yang digunakan pengguna (Bahasa Indonesia atau Bahasa Inggris). Jawab SELALU menggunakan bahasa yang sama dengan yang digunakan pengguna.
-   Gunakan emoji sesekali untuk membuat jawaban lebih hidup (contoh: ü¶é, üåä, ‚òÄÔ∏è, ‚õµ, üê†).
-   **PENTING:** Format jawaban Anda menggunakan HTML sederhana untukastikan tampilan yang rapi dan profesional.
    -   Gunakan tag \`<p>\` untuk setiap paragraf.
    -   Gunakan \`<ul>\` (dengan \`<li>\`) untuk daftar poin-poin.
    -   Gunakan \`<ol>\` (dengan \`<li>\`) untuk daftar bernomor.
    -   Gunakan \`<strong>\` untuk menebalkan teks penting.
    -   Pastikan untuk menutup semua tag HTML dengan benar.
    -   Jangan gunakan tag HTML lain selain yang disebutkan di atas (JANGAN GUNAKAN \`<div>\` atau \`<br>\`).
-   **FITUR GAMBAR:** Jika jawaban Anda akan lebih jelas dengan adanya gambar, Anda BISA menyisipkannya.
-   **CARA PENGGUNAAN GAMBAR:** Untuk menyisipkan gambar, tambahkan tag khusus ini **setelah** paragraf terkait: \`[Image of: <query pencarian gambar dalam Bahasa Inggris>]\`.
-   **ATURAN SANGAT PENTING UNTUK GAMBAR (AGAR TIDAK GAGAL MUAT):**
    1.  **Gunakan HANYA 1-3 KATA KUNCI (Bahasa Inggris):** Kueri WAJIB sangat singkat dan umum. Ini adalah aturan terpenting.
        -   **Contoh WAJIB DIIKUTI:** \`Padar Island\`, \`Komodo dragon\`, \`Pink Beach\`, \`Manta ray\`, \`Labuan Bajo harbor\`.
        -   **Contoh DILARANG (Akan Gagal):** \`Padar Island viewpoint Labuan Bajo\`, \`Komodo dragon on Rinca island\`, \`Beautiful Pink Beach aerial view\`.
    2.  **Hanya gunakan gambar jika esensial:** Jangan tambahkan gambar di setiap jawaban. Gunakan hanya untuk tempat ikonik atau hewan endemik.
    3.  **Jangan minta gambar untuk hal abstrak:** Hindari meminta gambar untuk "tips perjalanan" atau "sejarah Labuan Bajo".
-   **DI LUAR TOPIK:** Jika pertanyaan pengguna tidak ada hubungannya dengan Labuan Bajo (misal: "Apa ibu kota Prancis?"), ingatkan mereka dengan sopan (dalam bahasa yang mereka gunakan) bahwa Anda adalah bot spesialis Labuan Bajo.
-   Jaga agar jawaban tetap ringkas namun lengkap.
-   Mulai percakapan pertama dengan sapaan ramah (menggunakan tag \`<p>\`).`;

        // --- Elemen DOM ---
        const chatWindow = document.getElementById('chat-window');
        const inputForm = document.getElementById('input-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        // Variabel DOM suara dihapus

        // --- State Aplikasi ---
        let chatHistory = [];
        let isLoading = false;
        // Variabel state suara dihapus


        // --- Fungsi Helper ---

        /**
         * Menampilkan pesan di jendela chat.
         * @param {string} message - Teks pesan.
         * @param {'user' | 'bot'} sender - Pengirim pesan.
         */
        function displayMessage(message, sender) {
            // ... (Fungsi displayMessage yang ada, tidak berubah) ...
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', 'flex-col');
            
            const bubble = document.createElement('div');
            bubble.classList.add('px-4', 'py-3', 'rounded-lg', 'max-w-xs', 'md:max-w-md', 'lg:max-w-lg', 'shadow-sm', 'chat-bubble-content');
            
            let processedMessage = message;
            const imageTags = [];
            
            if (sender === 'bot') {
                const imageRegex = /\[Image of:\s*(.*?)\]/gi;
                processedMessage = message.replace(imageRegex, (match, query) => {
                    if (query) {
                        imageTags.push(query.trim());
                    }
                    return ''; 
                });
            }
            
            bubble.innerHTML = processedMessage;

            if (sender === 'user') {
                messageElement.classList.add('items-end');
                bubble.classList.add('bg-blue-600', 'text-white');
                bubble.innerHTML = ''; 
                bubble.innerText = message; 
            } else {
                messageElement.classList.add('items-start');
                bubble.classList.add('bg-gray-200', 'text-gray-900');
            }

            messageElement.appendChild(bubble);

            if (sender === 'bot' && imageTags.length > 0) {
                imageTags.forEach(query => {
                    const imgElement = document.createElement('img');
                    // Kembali ke source.unsplash.com untuk relevansi yang lebih baik
                    const imageUrl = `https://source.unsplash.com/600x400/?${encodeURIComponent(query)}`;
                    // Placeholder yang lebih netral
                    const placeholderUrl = `https://placehold.co/600x400/e2e8f0/94a3b8?text=Gagal+memuat+gambar...`;

                    imgElement.src = imageUrl;
                    imgElement.alt = `Gambar terkait: ${query}`;
                    imgElement.className = "w-full h-auto rounded-lg mt-3 border border-gray-200 bg-gray-100";
                    
                    imgElement.onerror = () => {
                        // Placeholder jika Unsplash gagal
                        imgElement.src = placeholderUrl;
                        imgElement.alt = `Gagal memuat gambar untuk: ${query}`;
                    };
                    
                    bubble.appendChild(imgElement); 
                });
            }

            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        /**
         * Menampilkan atau menyembunyikan indikator mengetik.
         * @param {boolean} show - True untuk menampilkan, false untuk menyembunyikan.
         */
        function toggleTypingIndicator(show) {
            // ... (Fungsi toggleTypingIndicator yang ada, tidak berubah) ...
            isLoading = show;
            typingIndicator.classList.toggle('hidden', !show);
            if (show) {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        /**
         * Mengirim permintaan ke API dengan exponential backoff.
         * @param {string} url - URL API.
         * @param {object} options - Opsi fetch.
         * @param {number} [retries=5] - Jumlah percobaan ulang.
         * @param {number} [delay=1000] - Waktu tunggu awal.
         */
        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
            // ... (Fungsi fetchWithBackoff yang ada, tidak berubah) ...
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                } else {
                    console.error("Gagal mengambil respons API setelah beberapa kali percobaan:", error);
                    throw error;
                }
            }
        }

        // --- Fungsi Text-to-Speech (speak) DIHAPUS ---
        

        /**
         * Mendapatkan respons dari bot (Gemini API).
         */
        async function getBotResponse(userInput) {
            toggleTypingIndicator(true);
            chatInput.disabled = true;
            sendButton.disabled = true;

            chatHistory.push({ role: "user", parts: [{ text: userInput }] });

            const payload = {
                // ... (Payload yang ada, tidak berubah) ...
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
                generationConfig: {
                    temperature: 0.7,
                    topP: 1.0,
                    maxOutputTokens: 1024,
                }
            };

            try {
                const result = await fetchWithBackoff(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const botMessage = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (botMessage) {
                    // Pemanggilan 'speak()' dihapus dari sini
                    displayMessage(botMessage, 'bot');
                    chatHistory.push({ role: "model", parts: [{ text: botMessage }] });
                } else {
                    console.error("Respons API tidak valid:", result);
                    const errorMsg = "<p>Maaf, sepertinya saya sedang mengalami sedikit gangguan. Coba tanyakan lagi nanti ya.</p>";
                    displayMessage(errorMsg, 'bot');
                    // Pemanggilan 'speak()' dihapus dari sini
                }

            } catch (error) {
                console.error("Error memanggil API:", error);
                const errorMsg = "<p>Aduh! üò• Saya sepertinya tidak bisa terhubung. Periksa koneksi internet Anda dan coba lagi.</p>";
                displayMessage(errorMsg, 'bot');
                // Pemanggilan 'speak()' dihapus dari sini
            } finally {
                toggleTypingIndicator(false);
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            }
        }

        /**
         * Menangani pengiriman form.
         * @param {Event} e - Event form.
         */
        function handleFormSubmit(e) {
            e.preventDefault();
            if (isLoading) return;

            // Pengecekan 'isRecording' dan 'synth.speaking' dihapus

            const userInput = chatInput.value.trim();
            if (userInput) {
                displayMessage(userInput, 'user');
                getBotResponse(userInput);
                chatInput.value = '';
            }
        }

        // --- Fungsi Speech-to-Text (initializeSpeechRecognition, dll) DIHAPUS ---
        

        // --- Event Listeners ---
        inputForm.addEventListener('submit', handleFormSubmit);
        sendButton.addEventListener('click', handleFormSubmit);
        // Event listener untuk tombol suara dihapus


        // --- Inisialisasi ---
        window.addEventListener('DOMContentLoaded', () => {
            const welcomeMessage = "<p>Halo! Saya Komo Bot, asisten Labuan Bajo Anda. / <i>Hi! I'm Komo Bot, your Labuan Bajo assistant.</i> ü¶é</p>";
            
            // Inisialisasi API Suara DIHAPUS

            // Tampilkan pesan selamat datang
            displayMessage(welcomeMessage, 'bot');
            chatHistory.push({ role: "model", parts: [{ text: welcomeMessage }] });

            // Penggantian alert() dihapus karena fungsinya sudah tidak ada
        });

    </script>
</body>
</html>


